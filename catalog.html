<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora Catalog | Acessórios</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root { --accent: #00f2ff; --bg: #000a12; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Header */
        header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,242,255,0.2); }
        #tix-display { color: var(--accent); font-weight: bold; font-size: 1.2rem; text-shadow: 0 0 10px var(--accent); }

        /* Main Layout */
        main { display: flex; flex: 1; overflow: hidden; }
        
        /* Preview 3D */
        #preview-container { width: 40%; background: radial-gradient(circle at center, #001a33 0%, #000 100%); position: relative; }
        
        /* Grid de Itens */
        #shop-container { width: 60%; padding: 20px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; align-content: start; }
        
        .item-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; text-align: center; transition: 0.3s; cursor: pointer; }
        .item-card:hover { border-color: var(--accent); background: rgba(0,242,255,0.05); }
        .item-card img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px; }
        .item-card h3 { font-size: 0.9rem; margin: 5px 0; }
        .item-card .price { color: var(--accent); font-weight: bold; font-size: 0.8rem; }
        .item-card.owned { border-color: #444; opacity: 0.8; }
        .item-card.equipped { border-color: #00ff00; box-shadow: 0 0 10px rgba(0,255,0,0.2); }

        .btn-back { background: none; border: 1px solid var(--accent); color: var(--accent); padding: 8px 15px; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>

    <header>
        <button class="btn-back" onclick="location.href='home.html'">< VOLTAR</button>
        <div id="tix-display">TIXS: --</div>
    </header>

    <main>
        <div id="preview-container"></div>
        <div id="shop-container">
            </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBvwC0_9DREMFIHFelYuc5RdfXz6bpo1JA",
            authDomain: "aurorapoint-a8a1e.firebaseapp.com",
            projectId: "aurorapoint-a8a1e",
            storageBucket: "aurorapoint-a8a1e.firebasestorage.app",
            messagingSenderId: "324340380415",
            appId: "1:324340380415:web:468fcca5188b539682d2ca"
        };

        // Database de Itens baseada na sua imagem
        const ITEM_DATABASE = [
            { id: 'mask_admin', name: 'Sorriso Adm', type: 'mask', price: 50, img: 'https://cdn-icons-png.flaticon.com/512/1023/1023656.png' },
            { id: 'hat_blue', name: 'Chapéu Azul', type: 'hat', price: 30, img: 'https://cdn-icons-png.flaticon.com/512/1051/1051167.png' },
            { id: 'belt_admin', name: 'Admin Abuse', type: 'waist', price: 100, img: 'https://cdn-icons-png.flaticon.com/512/806/806042.png' },
            { id: 'suit_classic', name: 'Terno Comum', type: 'shirt', price: 40, img: 'https://cdn-icons-png.flaticon.com/512/3531/3531831.png' },
            { id: 'shirt_classic', name: 'Camisa Comum', type: 'shirt', price: 15, img: 'https://cdn-icons-png.flaticon.com/512/2503/2503380.png' },
            { id: 'shorts_classic', name: 'Shorts Comum', type: 'pants', price: 20, img: 'https://cdn-icons-png.flaticon.com/512/2806/2806054.png' }
        ];

        let scene, camera, renderer, avatarMesh;
        let userData = { tixs: 0, inventory: [], equipped: {} };

        async function init() {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            
            firebase.auth().onAuthStateChanged(async user => {
                if (user) {
                    const doc = await firebase.firestore().collection("users").doc(user.uid).get();
                    if (doc.exists) {
                        userData = { ...userData, ...doc.data() };
                        if (!userData.inventory) userData.inventory = [];
                        if (!userData.equipped) userData.equipped = {};
                    }
                    updateUI();
                    init3D();
                } else {
                    window.location.href = 'index.html';
                }
            });
        }

        function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, (window.innerWidth*0.4)/window.innerHeight, 0.1, 100);
            camera.position.set(0, 1, 6);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth * 0.4, window.innerHeight);
            document.getElementById('preview-container').appendChild(renderer.domElement);

            const light = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(light);
            const directional = new THREE.DirectionalLight(0xffffff, 0.5);
            directional.position.set(2, 5, 2);
            scene.add(directional);

            // Criar o boneco R6 de preview
            avatarMesh = createR6Preview(userData.avatar);
            scene.add(avatarMesh);

            function animate() {
                requestAnimationFrame(animate);
                avatarMesh.rotation.y += 0.01;
                renderer.render(scene, camera);
            }
            animate();
        }

        function createR6Preview(colors = {}) {
            const group = new THREE.Group();
            const make = (w, h, d, x, y, z, col) => {
                const m = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshPhongMaterial({ color: col || 0xf1f10e }));
                m.position.set(x, y, z);
                group.add(m);
            };
            make(0.6, 0.6, 0.6, 0, 1.3, 0, colors['body-head']);
            make(0.9, 1.2, 0.5, 0, 0.4, 0, colors['body-torso']);
            make(0.4, 1.1, 0.4, -0.7, 0.4, 0, colors['body-larm']);
            make(0.4, 1.1, 0.4, 0.7, 0.4, 0, colors['body-rarm']);
            make(0.45, 1.1, 0.45, -0.25, -0.8, 0, colors['body-lleg']);
            make(0.45, 1.1, 0.45, 0.25, -0.8, 0, colors['body-rleg']);
            return group;
        }

        function updateUI() {
            document.getElementById('tix-display').innerText = `TIXS: ${userData.tixs || 0}`;
            const container = document.getElementById('shop-container');
            container.innerHTML = '';

            ITEM_DATABASE.forEach(item => {
                const isOwned = userData.inventory.includes(item.id);
                const isEquipped = userData.equipped[item.type] === item.id;

                const card = document.createElement('div');
                card.className = `item-card ${isOwned ? 'owned' : ''} ${isEquipped ? 'equipped' : ''}`;
                card.innerHTML = `
                    <img src="${item.img}">
                    <h3>${item.name}</h3>
                    <div class="price">${isOwned ? 'POSSUÍDO' : item.price + ' TIXS'}</div>
                `;
                card.onclick = () => handleItemAction(item);
                container.appendChild(card);
            });
        }

        async function handleItemAction(item) {
            const uid = firebase.auth().currentUser.uid;
            const userRef = firebase.firestore().collection("users").doc(uid);

            if (userData.inventory.includes(item.id)) {
                // Alternar Equipar/Desequipar
                if (userData.equipped[item.type] === item.id) {
                    delete userData.equipped[item.type];
                } else {
                    userData.equipped[item.type] = item.id;
                }
                await userRef.update({ equipped: userData.equipped });
            } else {
                // Comprar Item
                if (userData.tixs >= item.price) {
                    userData.tixs -= item.price;
                    userData.inventory.push(item.id);
                    await userRef.update({ 
                        tixs: userData.tixs, 
                        inventory: userData.inventory 
                    });
                    alert(`Você comprou: ${item.name}!`);
                } else {
                    alert("Tixs insuficientes!");
                }
            }
            updateUI();
        }

        init();
    </script>
</body>
</html>
